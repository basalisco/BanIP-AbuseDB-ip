name: Update AbuseIPDB Clean Lists

on:
  schedule:
    - cron: "0 */1 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Generate cleaned lists
        run: |
          clean_only() {
            URL="$1"
            OUT="$2"

            curl -A "Mozilla/5.0" -L --insecure -s "$URL" || true \
              | sed 's/\r$//' \
              | sed 's/#.*$//' \
              | tr -d ' \t' \
              | grep -Eo '^([0-9]{1,3}\.){3}[0-9]{1,3}(/([0-9]|[1-2][0-9]|3[0-2]))?$' \
              | sort -u \
              > "$OUT" || true
          }

          cclean_only() {
                OUT="$2"
                URL="$1"

                curl -A "Mozilla/5.0" -L --insecure -s "$URL" || true \
                  | sed 's/\r$//' \
                  | sed 's/#.*$//' \
                  | sed 's/;.*$//' \
                  | sed 's/,.*$//' \
                  | sed 's/:.*$//' \
                  | sed 's/[[:space:]].*$//' \
                  | tr -d ' \t' \
                  | grep -Eo '^([0-9]{1,3}\.){3}[0-9]{1,3}(/([0-9]|[1-2][0-9]|3[0-2]))?$' \
                  | sort -u \
                  > "$OUT" || true
              }


          ###############################################
          #  ABUSEIPDB LISTS
          ###############################################

          clean_only "https://raw.githubusercontent.com/borestad/blocklist-abuseipdb/refs/heads/main/abuseipdb-s100-1d.ipv4" abuseipdb-s100-1d-clean.txt || true
          clean_only "https://raw.githubusercontent.com/borestad/blocklist-abuseipdb/refs/heads/main/abuseipdb-s100-3d.ipv4" abuseipdb-s100-3d-clean.txt || true
          clean_only "https://raw.githubusercontent.com/borestad/blocklist-abuseipdb/refs/heads/main/abuseipdb-s100-7d.ipv4" abuseipdb-s100-7d-clean.txt || true
          clean_only "https://raw.githubusercontent.com/borestad/blocklist-abuseipdb/refs/heads/main/abuseipdb-s100-14d.ipv4" abuseipdb-s100-14d-clean.txt || true
          clean_only "https://raw.githubusercontent.com/borestad/blocklist-abuseipdb/refs/heads/main/abuseipdb-s100-30d.ipv4" abuseipdb-s100-30d-clean.txt || true
          clean_only "https://raw.githubusercontent.com/borestad/blocklist-abuseipdb/refs/heads/main/abuseipdb-s100-60d.ipv4" abuseipdb-s100-60d-clean.txt || true
          clean_only "https://raw.githubusercontent.com/borestad/blocklist-abuseipdb/refs/heads/main/abuseipdb-s100-90d.ipv4" abuseipdb-s100-90d-clean.txt || true
          clean_only "https://raw.githubusercontent.com/borestad/blocklist-abuseipdb/refs/heads/main/abuseipdb-s100-120d.ipv4" abuseipdb-s100-120d-clean.txt || true
          clean_only "https://raw.githubusercontent.com/borestad/blocklist-abuseipdb/refs/heads/main/abuseipdb-s100-180d.ipv4" abuseipdb-s100-180d-clean.txt || true
          clean_only "https://raw.githubusercontent.com/borestad/blocklist-abuseipdb/refs/heads/main/abuseipdb-s100-365d.ipv4" abuseipdb-s100-365d-clean.txt || true

          ###############################################
          #  EXTRA PUBLIC BLOCKLISTS
          ###############################################

          clean_only "https://raw.githubusercontent.com/bitwire-it/ipblocklist/main/inbound.txt" bitwire-inbound-clean.txt || true

          clean_only "http://iplists.firehol.org/files/firehol_level1.netset" firehol-level1-clean.txt || true
          clean_only "http://iplists.firehol.org/files/firehol_level2.netset" firehol-level2-clean.txt || true
          clean_only "http://iplists.firehol.org/files/firehol_level3.netset" firehol-level3-clean.txt || true
          clean_only "http://iplists.firehol.org/files/firehol_level4.netset" firehol-level4-clean.txt || true

          clean_only "https://www.dshield.org/block.txt" dshield-block-clean.txt || true

          clean_only "https://openphish.com/feed.txt" openphish-clean.txt || true

          clean_only "https://www.spamhaus.org/drop/drop.txt" spamhaus-drop-clean.txt || true
          clean_only "https://www.spamhaus.org/drop/edrop.txt" spamhaus-edrop-clean.txt || true

          clean_only "https://cinsscore.com/list/ci-badguys.txt" ciarmy-badguys-clean.txt || true

          clean_only "https://lists.blocklist.de/lists/all.txt" blocklistde-all-clean.txt || true

          clean_only "https://rules.emergingthreats.net/fwrules/emerging-Block-IPs.txt" emergingthreats-block-clean.txt || true

          clean_only "https://feodotracker.abuse.ch/downloads/ipblocklist.txt" feodo-block-clean.txt || true

          clean_only "https://sslbl.abuse.ch/blacklist/sslipblacklist.txt" sslbl-ip-clean.txt || true

          clean_only "https://urlhaus.abuse.ch/downloads/ipblocklist.txt" urlhaus-ip-clean.txt || true

          clean_only "https://talosintelligence.com/documents/ip-blacklist" talos-blacklist-clean.txt || true

          clean_only "https://www.stopforumspam.com/downloads/toxic_ip.txt" stopforumspam-toxic-clean.txt || true

          clean_only_zip "https://myip.ms/files/blacklist/general/full_blacklist_database.zip" myipms-blacklist-clean.txt || true

      - name: Commit changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add *.txt
          git commit -m "Update cleaned blocklists" || echo "No changes"
          git push
